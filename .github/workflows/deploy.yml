name: Deploy Backend Services

# 1) Define when this should run (e.g. on push to main)
on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    name: SSH & Redeploy on VM
    runs-on: ubuntu-24.04
    steps:
      - name: SSH & deploy backend
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          port: 22
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          request_pty: true
          script: |
            set -e
            cd ~/backendPfe

            echo "ðŸ“¦ Pulling latest codeâ€¦"
            git pull origin main

            for svc in users flight hotel gateway; do
              echo "ðŸ”¨ Building $svcâ€¦"
              cd $svc
              mvn clean package -DskipTests
              cd ..
            done

            echo "ðŸ”„ Restarting servicesâ€¦"
            sudo systemctl restart users
            sudo systemctl restart flight
            sudo systemctl restart hotel
            sudo systemctl restart gateway

            echo "âœ… Backend redeployed!"
